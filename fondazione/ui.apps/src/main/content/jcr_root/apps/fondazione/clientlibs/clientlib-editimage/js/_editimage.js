document.addEventListener("DOMContentLoaded",(async function(){console.log("Edit Image Component Loaded");const e=document.getElementById("loadImageCta"),t=document.getElementById("fileInputEditImage");document.getElementById("errorMessage");let a=document.querySelector("#editImageImgWrapper"),n=document.querySelector("#ctaSaveEditImage"),o=document.querySelector("#editImageLoader"),i=document.querySelector("#editImageImg"),r=document.querySelector("#editProfileLinkLogout"),s=null,c=[];!async function(){const e=await fetch("/libs/granite/csrf/token.json"),t=await e.json(),n=await fetch("/private/api/profile/image",{method:"GET",headers:{"CSRF-Token":t.token}}),o=await n.json();""!==o.imageData&&i&&a&&(i.src="data:image/jpeg;base64,"+o.imageData,a.classList.add("d-block"),a.classList.remove("d-none"))}();let d=!1;try{const e=await fetch("/libs/granite/csrf/token.json"),t=await e.json();200===(await fetch("/private/api/isSignIn",{method:"GET",headers:{"CSRF-Token":t.token}})).status&&(d=!0)}catch(e){console.log("Error: ",e)}if(r&&r.addEventListener("click",(async function(){let e=r.dataset.redirectLink;try{const t=await fetch("/libs/granite/csrf/token.json"),a=await t.json();200===(await fetch("/private/api/signout",{method:"POST",headers:{"CSRF-Token":a.token}})).status&&(window.location.href=e)}catch(e){console.log("Error: ",e)}})),d){const e=await fetch("/libs/granite/csrf/token.json"),t=await e.json(),a=await fetch("/private/api/user",{method:"GET",headers:{"CSRF-Token":t.token}});let n=await a.json(),o=document.querySelector("#editImageUserName"),i=document.querySelector("#editImageUserEmail");n&&i&&o&&(i.textContent=n.updatedUser.email,o.textContent=n.updatedUser.firstname+" "+n.updatedUser.lastname)}e?.addEventListener("click",(function(){t&&t.click()})),t?.addEventListener("change",(async function(e){let o=document.querySelector("#cmp-editImage__successAlert"),r=document.querySelector("#cmp-editImage__errorsAlert"),d=document.querySelector("#cmp-editImage__errorsList");if(c=[],o&&r&&d&&(o.classList.add("d-none"),o.classList.remove("d-block"),r.classList.add("d-none"),r.classList.remove("d-block"),d.innerHTML=""),s=e.target.files[0],s){const e=function(e){if(e.size>256e3&&t)return c.push(Granite.I18n.get("error_image_size")),t.value="",!1;return!0}(s),o=function(e){if(!["image/jpeg","image/png"].includes(e.type)&&t)return c.push(Granite.I18n.get("error_image_format")),t.value="",!1;return!0}(s),l=await function(e,t){return new Promise((t=>{const a=new Image;a&&(a.onload=function(){a.width<100||a.width>512||a.height<100||a.height>512?(c.push(Granite.I18n.get("error_image_dimension")),t(!1)):t(!0)},a.src=URL.createObjectURL(e))}))}(s);e&&o&&l&&0===c.length&&n?(n.disabled=!1,function(e){a&&i&&(i.src=URL.createObjectURL(e),a.classList.add("d-block"),a.classList.remove("d-none"))}(s)):r&&d&&(r.classList.add("d-block"),r.classList.remove("d-none"),c.forEach((e=>{let t=document.createElement("li");t.textContent=e,d.appendChild(t)})))}})),n&&(n.disabled=!0,n.addEventListener("click",(()=>async function(){o&&n&&(o.classList.add("d-block"),o.classList.remove("d-none"),n.disabled=!0);let e=localStorage.getItem("token"),t=null,a=null;try{t=await function(e){return new Promise(((t,a)=>{const n=new FileReader;n&&(n.onload=()=>t(n.result),n.onerror=e=>a(e),n.readAsDataURL(e))}))}(s),a={imageData:t.split(",")[1]}}catch(e){console.error(Granite.I18n.get("error_image_conversion"),e)}if(e&&0===c.length){if("false"===localStorage.getItem("remember_me")){let t=JSON.parse(e);token=t.token}else token=e;try{const e=await fetch("/libs/granite/csrf/token.json"),t=await e.json(),i=await fetch("/private/api/profile/image",{method:"POST",headers:{"CSRF-Token":t.token,Authorization:"Bearer "+token},body:JSON.stringify(a)});if(!0===(await i.json()).success){let e=document.querySelector("#cmp-editImage__successAlert");e.classList.add("d-block"),e.classList.remove("d-none")}}catch(e){console.log("Error: ",e)}finally{n&&o&&(n.disabled=!1,o.classList.add("d-none"),o.classList.remove("d-block"))}}}())))}));